
# TCP粘包&拆包处理

产生TCP粘包和拆包问题的主要原因是，操作系统在发送TCP数据的时候，底层会有一个缓冲区，例如1024个字节大小，如果一次请求发送的数据量比较小，没达到缓冲区大小，TCP则会将多个请求合并为同一个请求进行发送，这就形成了粘包问题；如果一次请求发送的数据量比较大，超过了缓冲区大小，TCP就会将其拆分为多次发送，这就是拆包，也就是将一个大的包拆分为多个小包进行发送。

而UDP是有消息保护边界的，不会发生粘包、拆包问题，只发生在TCP协议中。假设客户端向服务端发送了两个连续的数据包Packet1、Packet2；

在这个过程中可能会出现3种情况：

  1. 正常：两个数据包逐一分开发送

  2. 粘包：两个包一同发送

  3. 拆包：Server接收到不完整的或多出一部分的数据包


![](/uploads/upload_ff4d646fd2674e6be25c363bf001ab45.png)

出现以上的拆包和粘包原因主要有以下四个

粘包原因：

a）应用程序一次写入的数据 > 套接字缓冲区的大小；

b）接收时不及时读取套接字缓冲区的数据；

拆包原因：
a）应用程序一次写入的数据 < 套接字缓冲区的大小；

b）进行MSS最大报文的一个TCP分段时，当TCP报文的长度 - TCP头部的长度 > MSS；

解决方法有三种，具体如下：
（1）发送端给每个数据包添加包首部，首部长度应该至少包含数据包的长度 ；

（2）固定每次发送的报文长度，不够用0补充；

（3）约定好包的边界，添加首部尾部标识，如特许字符；