# 进程同步

![](/uploads/upload_c1e8e5322fc314bce16f9cd004748dbc.png)


进程同步的主要任务是对多个相关进程在 执行次序上进行协调，以使并发执行的诸进程之间能有效地共享资源和相互合作，从而使 程序的执行具有可再现性。

## 制约关系

1. 间接相互制约关系。同处于一个系统中的进程，通常都共享着某种系统资源，如共 享 CPU、共享 I/O 设备等。所谓间接相互制约即源于这种资源共享，例如，有两个进程 A 和 B，如果在 A 进程提出打印请求时，系统已将惟一的一台打印机分配给了进程 B，则此 时进程 A 只能阻塞;一旦进程 B 将打印机释放，则 A 进程才能由阻塞改为就绪状态。

2. 直接相互制约关系。这种制约主要源于进程间的合作。例如，有一输入进程 A 通过 单缓冲向进程 B 提供数据。当该缓冲空时，计算进程因不能获得所需数据而阻塞，而当进 程 A 把数据输入缓冲区后，便将进程 B 唤醒;反之，当缓冲区已满时，进程 A 因不能再向 缓冲区投放数据而阻塞，当进程 B 将缓冲区数据取走后便可唤醒 A。

## 临界资源

许多硬件资源如打印机、磁带机等，都属于临界资源 (Critical Resouce)，诸进程间应采取互斥方式，实现对这种资源的共享。

## 临界区

不论是硬件临界资源，还是软件临界资源，多个进程必须互斥地对它进行访问。人们把在每个进程中访问临界资源的那段代码称为临界区(critical section)。

## 同步机制应遵循的规则

为实现进程互斥地进入自已的临界区，可用软件方法，更多的是在系统中设置专门的 同步机构来协调各进程间的运行。所有同步机制都应遵循下述四条准则:

1. 空闲让进。当无进程处于临界区时，表明临界资源处于空闲状态，应允许一个请求 进入临界区的进程立即进入自己的临界区，以有效地利用临界资源。

2. 忙则等待。当已有进程进入临界区时，表明临界资源正在被访问，因而其它试图进 入临界区的进程必须等待，以保证对临界资源的互斥访问。

3. 有限等待。对要求访问临界资源的进程，应保证在有限时间内能进入自己的临界区， 以免陷入“死等”状态。

4. 让权等待。当进程不能进入自己的临界区时，应立即释放处理机，以免进程陷入“忙 等”状态。

## 进程同步方式

### 信号量机制

1. **整型信号量**
    
    把整型信号量定义为一个用于表示资源数目的整型量 S，它与一般整型 量不同，除初始化外，仅能通过两个标准的原子操作(Atomic Operation) wait(S)和signal(S) 来访问。很长时间以来，这两个操作一直被分别称为 P（递减）、V（递增） 操作。

    基本原理是两个或多个进程可以通过简单的信号进行合作，一个进程可以被迫在某一位置停止，直到它接收到一个特定的信号。该信号即为信号量s。
     
    为通过信号量s传送信号，进程可执行原语semSignal(s);为通过信号量s接收信号，进程可执行原语semWait(s);如果相应的信号仍然没有发送，则进程被阻塞，直到发送完为止。

    可把信号量视为一个具有整数值的变量，在它之上定义三个操作：

    - 一个信号量可以初始化为非负数
    
    - semWait操作使信号量s减1.若值为负数，则执行semWait的进程被阻塞。否则进程继续执行。
    
    - semSignal操作使信号量加1，若值大于或等于零，则被semWait操作阻塞的进程被解除阻塞。

2. 记录型信号量

    在整型信号量机制中的 wait 操作，只要是信号量 S≤0，就会不断地测试。因此，该机 制并未遵循“让权等待”的准则，而是使进程处于“忙等”的状态。记录型信号量机制则 是一种不存在“忙等”现象的进程同步机制。但在采取了“让权等待”的策略后，又会出 现多个进程等待访问同一临界资源的情况。为此，在信号量机制中，除了需要一个用于代 表资源数目的整型变量 value 外，还应增加一个进程链表指针 L，用于链接上述的所有等待 进程。记录型信号量是由于它采用了记录型的数据结构而得名的。

3. AND 型信号量

    AND 同步机制的基本思想是:将进程在整个运行过程中需要的所有资源，一次性全部 地分配给进程，待进程使用完后再一起释放。只要尚有一个资源未能分配给进程，其它所 有可能为之分配的资源也不分配给它。亦即，对若干个临界资源的分配，采取原子操作方 式:要么把它所请求的资源全部分配到进程，要么一个也不分配。由死锁理论可知，这样 就可避免上述死锁情况的发生。为此，在 wait 操作中，增加了一个“AND”条件，故称为 AND 同步

4. 信号量集

    在记录型信号量机制中，wait(S)或 signal(S)操作仅能对信号量施以加 1 或减 1 操作，意 味着每次只能获得或释放一个单位的临界资源。而当一次需要 N 个某类临界资源时，便要 进行 N 次 wait(S)操作，显然这是低效的。此外，在有些情况下，当资源数量低于某一下限 值时，便不予以分配。因而，在每次分配之前，都必须测试该资源的数量，看其是否大于 其下限值。基于上述两点，可以对 AND 信号量机制加以扩充，形成一般化的“信号量集” 机制。
    
### 管程机制

 管程是由一个或多个过程、一个初始化序列和局部数据组成的软件模块，其主要特点如下：

- 局部数据变量只能被管程的过程访问，任何外部过程都不能访问。
- 一个进程通过调用管程的一个过程进入管程。
- 在任何时候，只能有一个进程在管程中执行，调用管程的任何其他进程都被阻塞，以等待管程可用。
     
管程通过使用条件变量提供对同步的支持，这些条件变量包含在管程中，并且只有在管程中才能被访问。有两个函数可以操作条件变量：

- cwait(c)：调用进程的执行在条件c上阻塞，管程现在可被另一个进程使用。
- csignal(c)：恢复执行在cwait之后因为某些条件而阻塞的进程。如果有多个这样的进程，选择其中一个；如果没有这样的进程，什么以不做。


### 消息传递

消息传递的实际功能以一对原语的形式提供：

- send(destination,message)
- receive(source,message)
     
这是进程间进程消息传递所需要的最小操作集。
一个进程以消息的形式给另一个指定的目标进程发送消息；
进程通过执行receive原语接收消息，receive原语中指明发送消息的源进程和消息。