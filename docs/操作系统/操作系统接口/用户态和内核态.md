# 用户态 和 内核态

内核态（Kernel Mode）：运行操作系统程序，操作硬件

用户态（User Mode）：运行用户程序

## 特权级

操作系统有特权级，一般是4级，分别为0-3，0级权限最高，3级权限最低。操作系统中核心的任务交给特权级高的进程完成，这样可以做到集中管理，减少有限资源的访问和使用冲突。

## 用户态和内核态之间的切换
- 系统调用

    这是用户态进程主动要求进入内核态的方式。用户态进程通过系统调用申请使用操作系统提供的服务程序完成工作。例如fork()就是创建一个新的进程的系统调用。系统调用的核心机制是使用操作系统为用户特别开放的一个中断来实现。

- 异常

    当CPU在执行用户态程序时，如果发生了一些不可预知的异常，这时就会触发由当前运行进程切换到此异常相关的内核进程中，也就是切换到了内核态，比如缺页异常

- 外围设备的中断

    当外围设备完成用户请求的操作以后，会向CPU发出相应的中断信号，这时CPU会暂停执行下一条即将要执行的指令转而去执行与中断信号对应的处理程序。如果之前的指令处于用户态，那么这个转换过程就是从用户态到内核态的一个转换过程。比如硬盘读写完成，系统会切换到硬盘读写的中断处理程序中执行后续操作。

## 切换步骤

- 首先获取内核栈的基本信息，栈顶栈底
- 然后用内核栈保存当前进程的上下文基本信息，比如指令计数器等，这个过程就完成了用户态到内核态的切换
- 将之前由中断向量得到的中断处理程序的指令信息存入相应的寄存器，开始执行中断处理程序，此时就是内核态的程序执行了
- 最后当内核态的程序执行完毕，通过内核栈中用户进程的上下文信息恢复用户进程的执行，这个过程就相当于调用函数完成，函数返回。