# 负载均衡原理

- 四层负载均衡工作在OSI模型的传输层，主要工作是转发，它在接收到客户端的流量以后通过修改数据包的地址信息将流量转发到应用服务器。

- 七层负载均衡工作在OSI模型的应用层，因为它需要解析应用层流量，所以七层负载均衡在接到客户端的流量以后，还需要一个完整的TCP/IP协议栈。七层负载均衡会与客户端建立一条完整的连接并将应用层的请求流量解析出来，再按照调度算法选择一个应用服务器，并与应用服务器建立另外一条连接将请求发送过去，因此七层负载均衡的主要工作就是代理。

## DNS负载均衡

![](/uploads/upload_4b2f15531b0a3f2d3e46ce1d1deaa4ab.png)

这样做有个很要命的问题，由于DNS这个分层的系统中有缓存，用户端的机器也有缓存，如果某个机器出故障，域名解析仍然会返回那个出问题机器的IP，那所有访问该机器的用户都会出问题， 即使我们把这个机器的IP从DNS中删除也不行， 这就麻烦了

## 四层负载均衡

![](/uploads/upload_e135148ca8401905768fcefe42ccae76.png)

报文变换：

1. 客户发给LB的数据包

   ![](/uploads/upload_7328d1e9a265a03e5697f6e9487ab0c9.png)


2. LB动了手脚，把目的地IP和端口改为RS1的

   ![](/uploads/upload_4aeae81c55dcbff7b864a0f1ef4da988.png)

3. RS1处理完了，要发送结果给客户端

   ![](/uploads/upload_6c146e7719ab026cd2237cad8988b96f.png)


4. LB再次动手脚，把源地址和端口改成自己的， 让客户端毫无察觉

   ![](/uploads/upload_1cefb97726177d223e5823c78cb97649.png)



客户端 --> Load Balancer --> RS --> Load Balancer --> 客户端