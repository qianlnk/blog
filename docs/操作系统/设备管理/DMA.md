# 直接存储器访问(DMA)I/O控制方式

## 1.DMA(Direct Memory Access)控制方式的引入

虽然中断驱动 I/O 比程序 I/O 方式更有效，但须注意，它仍是以字(节)为单位进行 I/O 的，每当完成一个字(节)的 I/O 时，控制器便要向 CPU 请求一次中断。换言之，采用中断 驱动 I/O 方式时的 CPU 是以字(节)为单位进行干预的。如果将这种方式用于块设备的 I/O， 显然是极其低效的。例如，为了从磁盘中读出 1 KB 的数据块，需要中断 CPU 1K 次。为了 进一步减少 CPU 对 I/O 的干预而引入了直接存储器访问方式，见图 5-7(c)所示。该方式的 特点是:

(1) 数据传输的基本单位是数据块，即在 CPU 与 I/O 设备之间，每次传送至少一个数 据块;
(2) 所传送的数据是从设备直接送入内存的，或者相反;
(3) 仅在传送一个或多个数据块的开始和结束时，才需 CPU 干预，整块数据的传送是 在控制器的控制下完成的。

可见，DMA 方式较之中断驱动方式，又是成百倍地减少了 CPU 对 I/O 的干预，进一步 提高了 CPU 与 I/O 设备的并行操作程度。

## 2.DMA 控制器的组成
DMA 控制器由三部分组成:主机与 DMA 控制器的接口;DMA 控制器与块设备的接 口;I/O 控制逻辑。图 5-8 示出了 DMA 控制器的组成。这里主要介绍主机与控制器之间的 接口。

![](/uploads/upload_9c5837f7f17c5cf894cd02cf0354d6c1.png)

为了实现在主机与控制器之间成块数据的直接交换，必须在 DMA 控制器中设置如下四 类寄存器:

(1) 命令/状态寄存器(CR)。用于接收从 CPU 发来的 I/O 命令，或有关控制信息，或设 备的状态。
(2) 内存地址寄存器(MAR)。在输入时，它存放把数据从设备传送到内存的起始目标地 址;在输出时，它存放由内存到设备的内存源地址。
(3) 数据寄存器(DR)。用于暂存从设备到内存，或从内存到设备的数据。
(4) 数据计数器(DC)。存放本次 CPU 要读或写的字(节)数。

## 3.DMA 工作过程
我们以从磁盘读入数据为例，来说明 DMA 方式的工作流程。当 CPU 要从磁盘读入一数据块时，便向磁盘控制器发送一条读命令。该命令被送到其中的命令寄存器(CR)中。同 时，还须发送本次要将数据读入的内存起始目标地址，该地址被送入内存地址寄存器(MAR) 中;本次要读数据的字(节)数则送入数据计数器(DC)中，还须将磁盘中的源地址直接送至 DMA 控制器的 I/O 控制逻辑上。然后，启动 DMA 控制器进行数据传送，以后，CPU 便可 去处理其它任务。此后，整个数据传送过程便由 DMA 控制器进行控制。当 DMA 控制器已 从磁盘中读入一个字(节)的数据并送入数据寄存器(DR)后，再挪用一个存储器周期，将该字 (节)传送到 MAR 所指示的内存单元中。接着便对 MAR 内容加 1，将 DC 内容减 1。若减 1 后 DC 内容不为 0，表示传送未完，便继续传送下一个字(节);否则，由 DMA 控制器发出 中断请求。图 5-9 是 DMA 方式的工作流程。

![](/uploads/upload_a0f379636c0465d4ce73229247fd7933.png)