# 进程控制

进程控制是进程管理中最基本的功能。它用于创建一个新进程，终止一个已完成的进 程，或终止一个因出现某事件而使其无法运行下去的进程，还可负责进程运行中的状态转 换。如当一个正在执行的进程因等待某事件而暂时不能继续执行时，将其转换为阻塞状态， 而当该进程所期待的事件出现时，又将该进程转换为就绪状态等等。进程控制一般是由 OS 的内核中的原语来实现的。


原语(Primitive)是由若干条指令组成的，用于完成一定功能的一个过程。它与一般过程 的区别在于:它们是“原子操作(Action Operation)”。

原语的作用是为了实现进程的通信和控制，系统对进程的控制如不使用原语，就会造成其状态的不确定性，从而达不到进程控制的目的。

## 进程的创建过程

1. **申请空白的PCB**。为新进程申请获得惟一的数字标识符，并从 PCB 集合中索取一个 空白 PCB。

2. **为新进程分配资源**。为新进程的程序和数据以及用户栈分配必要的内存空间。显然， 此时操作系统必须知道新进程所需内存的大小。对于批处理作业，其大小可在用户提出创建 进程要求时提供。若是为应用进程创建子进程，也应是在该进程提出创建进程的请求中给出 所需内存的大小。对于交互型作业，用户可以不给出内存要求而由系统分配一定的空间。如 果新进程要共享某个已在内存的地址空间(即已装入内存的共享段)，则必须建立相应的链接。

3. **初始化进程控制块。**PCB 的初始化包括:1 初始化标识信息，将系统分配的标识 符和父进程标识符填入新 PCB 中;2 初始化处理机状态信息，使程序计数器指向程序的入 口地址，使栈指针指向栈顶;3 初始化处理机控制信息，将进程的状态设置为就绪状态或 静止就绪状态，对于优先级，通常是将它设置为最低优先级，除非用户以显式方式提出高 优先级要求。

4. **将新进程插入就绪队列**，如果进程就绪队列能够接纳新进程，便将新进程插入就绪队列。

## 进程的终止过程

1. 根据被终止进程的标识符，从 PCB 集合中检索出该进程的 PCB，从中读出该进程的状态。

2. 若被终止进程正处于执行状态，应立即终止该进程的执行，并置调度标志为真，用于指示该进程被终止后应重新进行调度。

3. 若该进程还有子孙进程，还应将其所有子孙进程予以终止，以防它们成为不可控的进程。

4. 将被终止进程所拥有的全部资源，或者归还给其父进程，或者归还给系统。

5. 将被终止进程(PCB)从所在队列(或链表)中移出，等待其他程序来搜集信息。

## 进程阻塞过程

正在执行的进程，当发现上述某事件时，由于无法继续执行，于是进程便通过调用阻 塞原语 block 把自己阻塞。可见，进程的阻塞是进程自身的一种主动行为。进入 block 过程 后，由于此时该进程还处于执行状态，所以应先立即停止执行，把进程控制块中的现行状 态由“执行”改为“阻塞”，并将 PCB 插入阻塞队列。如果系统中设置了因不同事件而阻塞 的多个阻塞队列，则应将本进程插入到具有相同事件的阻塞(等待)队列。最后，转调度程序 进行重新调度，将处理机分配给另一就绪进程并进行切换，亦即，保留被阻塞进程的处理 机状态(在 PCB 中)，再按新进程的 PCB 中的处理机状态设置 CPU 的环境。

## 进程唤醒过程

当被阻塞进程所期待的事件出现时，如 I/O 完成或其所期待的数据已经到达，则由有关 进程(比如用完并释放了该 I/O 设备的进程)调用唤醒原语 wakeup( )，将等待该事件的进程唤醒。唤醒原语执行的过程是:首先把被阻塞的进程从等待该事件的阻塞队列中移出，将其 PCB 中的现行状态由阻塞改为就绪，然后再将该 PCB 插入到就绪队列中。

应当指出，block 原语和 wakeup 原语是一对作用刚好相反的原语。因此，如果在某进 程中调用了阻塞原语，则必须在与之相合作的另一进程中或其他相关的进程中安排唤醒原 语，以能唤醒阻塞进程;否则，被阻塞进程将会因不能被唤醒而长久地处于阻塞状态，从 而再无机会继续运行。

## 进程的挂起

当出现了引起进程挂起的事件时，比如，用户进程请求将自己挂起，或父进程请求将 自己的某个子进程挂起，系统将利用挂起原语 suspend( )将指定进程或处于阻塞状态的进程 挂起。挂起原语的执行过程是:首先检查被挂起进程的状态，若处于活动就绪状态，便将 其改为静止就绪; 对于活动阻塞状态的进程，则将之改为静止阻塞。为了方便用户或父进 程考查该进程的运行情况而把该进程的 PCB 复制到某指定的内存区域。最后，若被挂起的 进程正在执行，则转向调度程序重新调度。

## 进程的激活过程

当发生激活进程的事件时，例如，父进程或用户进程请求激活指定进程，若该进程驻 留在外存而内存中已有足够的空间时，则可将在外存上处于静止就绪状态的该进程换入内 存。这时，系统将利用激活原语 active( )将指定进程激活。激活原语先将进程从外存调入内 存，检查该进程的现行状态，若是静止就绪，便将之改为活动就绪;若为静止阻塞，便将 之改为活动阻塞。假如采用的是抢占调度策略，则每当有新进程进入就绪队列时，应检查 是否要进行重新调度，即由调度程序将被激活进程与当前进程进行优先级的比较，如果被 激活进程的优先级更低，就不必重新调度;否则，立即剥夺当前进程的运行，把处理机分 配给刚被激活的进程。