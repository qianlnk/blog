
# 半关连接 和 半开连接

在前面部分我们我们分别介绍了三次握手、四次挥手、同时打开和同时关闭，TCP连接还有两种场景分别是半打开(Half-Open)连接和半关闭(Half-Close)连接。TCP是一个全双工(Full-Duplex)协议，因此这里的半连接"半"字就是相对于全双工的"全"来说的。

一、半开连接

从协议定义的角度来说，TCP的半开连接是指TCP连接的一端异常崩溃，或者在未通知对端的情况下关闭连接，这种情况下不可以正常收发数据，否则会产生RST。比如一个常见的情况是TCP连接的一端异常断电，就会导致TCP的半开连接。如果没有数据传输，对端就不会知道本端的异常而一直处于ESTABLISHED状态(TCP有存活检测机制，后面内容我们会进行介绍)。

另外从linux实现的角度来说，因为linux内部有个半连接队列，TCP半开连接是指发送了TCP连接请求，等待对方应答的状态，此时连接并没有完全建立起来,双方还无法进行通信交互的状态，此时就称为半连接。由于一个完整的TCP连接需要经过三次握手才能完成,这里把三次握手之前的连接都称之为半连接。

二、半关连接

**TCP的半关连接是指TCP连接只有一方发送了FIN，另一方没有发出FIN包，仍然可以在一个方向上正常发送数据。** 这种场景并不常见，一般来说Berkeley sockets API调用shutdown()接口时候就会进入半关闭状态(调用常规的close()一般是期待完整的双向关闭这个TCP连接)，shutdown()接口相当指示程序，本端已经没有数据待发送，所以我发送一个FIN到对端，但是我仍然想要从对端接收数据，直到对端发送一个FIN指示关闭连接为止。如下图所示，在红色背景文本框标注的数据传输场景下就是TCP的半关连接

![](/uploads/upload_42f13a307b0dfba60d4957850c4e5cce.png)
