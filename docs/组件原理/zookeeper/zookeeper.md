# zookeeper

一个高可用(因为zk是一个集群，单点故障下仍然可以恢复)且具备严格顺序访问控制能力(一定要保证事件的因果顺序)的分布式协调系统，它是一个分布式数据一致性(保证分布式情况下，数据一致)的解决方案。

zk提供了分布式通知和协调、配置管理、命名服务、主节点选举、分布式锁、分布式队列等解决方案。

其中分布式通知和协调被广泛用于服务发现（是服务发现领域历史最悠久、使用最广泛的产品）。

ZK也是Hadoop和HBased分布式协调组件。

ZK本质上是一个强一致性的产品，在集群发生分区时它会保证一致性而舍弃可用性，它是一个基于CP的系统。

ZK的每个服务端（Server）存储的数据都是一致的，存在唯一一个leader。客户端（Client）连接到任意一个ZK的服务端都能得到一致的最新数据副本。

Paxos算法和Zab协议：

zk是如何保证多个服务端的数据一致性呢：（就是说多个ZK server是为了高可用，但是如何保证多个server之间的数据一致性呢？在kafka中，kafka brokers就是clients，它们连到多个ZK server上，必须要保证这些ZK server数据一致。）

zk是通过消息传递保持分布式节点之间的数据一致性。zab是专门针对ZK而设计的支持崩溃恢复的原子广播协议。

ZK的客户端是随机连接到zk集群的某个节点上的。read请求直接从连接的ZK server上读取；write请求，会由收到的server向leader server 提交事务，再由leader节点广播事务。只有超过半数的节点都写入成功，write请求才会被提交。

zab协议规定，消息传递需要遵循三个规则： 可靠递交、完全有序、和因果有序。

在主节点崩溃的情况下，zab协议通过主节点快速选举、初始化、同步从节点、广播这几个阶段来保证数据的一致性和主节点选举的高效性：　　

- 阶段0： 主节点快速选举 - 在集群刚刚重启或者主节点刚刚崩溃时，只要超过半数的节点投票就可以生效。不需要等所有节点都投票就可以选举出leader。
- 阶段1： 初始化 -  从节点根据主节点新生成的“年号”更新它们的Epoch。
- 阶段2： 同步从节点 - 从节点与主节点同步最近接收的事务提议。
- 阶段3： 广播 - zk集群正式对外提供服务。

**核心概念：**

1. 集群角色：主节点（leader）、从节点（Follower）、和观察者（Observer ), 在ZK集群中，服务器数量是奇数被认为是最佳实践（ zk集群对外可用的必要条件是：超过半数的服务器正常工作。）  2台的宕机容忍度为0； 3台的宕机容忍度是1；4台的宕机容忍度也是1.

2. 会话：zk集群中，客户端与服务端是通过TCP建立长连接的。客户端和服务端通过心跳来保持连接。断了后可以在会话允许时间内再建立连接不影响工作。

3. 数据节点：zk中数据节点的英文名字是Znode，树形结构。

4. 监听：zk允许客户端在其感兴趣的Znode上注册监听器，该Znode的状态发生变更时，服务端将直接通知客户端处理。